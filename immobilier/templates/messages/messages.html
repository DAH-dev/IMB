<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IMMO ABIDJAN - Messages</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    {% load static %}
    <style>
        /* (Conserver votre CSS ici, il n'y a pas de changement) */
        :root {
            --primary: #1e4a8d;
            --accent: #ff6b00;
            --light: #f8f9fa;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
        }

        .main-content {
            width: 100%;
        }

        .icon-badge {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
            margin-right: 10px;
        }

        .bg-primary {
            background-color: #007bff;
        }

        .bg-success {
            background-color: #28a745;
        }

        .bg-warning {
            background-color: #ffc107;
        }

        .bg-info {
            background-color: #17a2b8;
        }

        .logo {
            font-size: 12px;
        }

        .ma_section_identity {
            font-size: 10px;
        }

        .identity {
            font-size: 14px;
        }

        .sidebar {
            background-color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            left: -250px;
            width: 250px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1050;
            transition: left 0.3s ease-in-out;
        }

        .sidebar.active {
            left: 0;
        }

        .main-content {
            transition: all 0.3s ease-in-out;
            padding: 1rem;
            padding-top: 40px;
            height: 100vh;
            overflow: hidden;
        }

        .main-content.shifted {
            margin-left: 200px;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            top: 0;
            z-index: 1000;
            position: fixed;
            width: 100%;
            height: 40px;
        }

        .dashboard-card {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        #mobileMenuBtn {
            position: fixed;
            top: 11px;
            left: 19px;
            z-index: 1100;
            background-color: transparent;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #000;
            background: var(--primary);
            color: white;
            border-radius: 4px;
        }

        .navbar h5 {
            font-size: 12px;
            margin-left: 20px;
        }

        .navbar .btn-accent {
            font-size: 12px;
        }

        .sidebar a {
            font-size: 12px;
            font-weight: 500;
            padding: 5px 20px;
        }

        .messaging-layout {
            display: flex;
            gap: 20px;
            height: 100%;
            height: calc(100vh - 100px);
            overflow: hidden;
            flex: 1;
        }

        .toutechange {
            height: calc(100vh - 40px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            flex: 1;
            border-top: 1px solid #ddd;
        }

        .conversations-list {
            width: 30%;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            max-height: 100%;
        }

        .conversations-list .list-group-item {
            border: none;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 12px;
            padding: 5px;
        }

/* Corrections pour la partie chat */
.chat-window {
 width: 70%;
 display: flex;
 flex-direction: column;
 height: 100%;
}

.chat-container {
 display: flex;
 flex-direction: column;
 height: 100%;
}

.chat-messages {
 flex-grow: 1;
 overflow-y: auto;
 padding: 15px;
 background: #fff;
 border-radius: 10px;
}

.chat-input {
 margin-top: 10px;
 margin-bottom: 0;
}

/* Règle pour les messages reçus (par défaut) */
.chat-message p {
     display: inline-block;
padding: 5px 10px;
 border-radius: 15px;
 background-color: var(--light); /* Fond clair pour les messages de l'autre utilisateur */
 max-width: 70%;
}

/* Règle pour les messages envoyés par l'utilisateur */
.chat-message.from-user {
 text-align: right;
}

.chat-message.from-user p {
 background-color: var(--primary); /* Fond principal (bleu) pour les messages envoyés */
color: white; /* Texte blanc */
}

       
/* ... (votre CSS existant, sans changement) ... */

@media (max-width: 768px) {
    .messaging-layout {
        display: block !important;
        width: 100% !important;
    }

    .conversations-list {
        display: none;
        width: 100% !important;
        max-width: 100% !important;
    }

    .conversations-list.active {
        display: block;
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100vh;
        background: white;
        z-index: 1200;
        overflow-y: auto;
    }

    .chat-window {
        width: 100% !important;
        height: 100vh !important;
        display: flex;
        flex-direction: column;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative; /* Important pour que le formulaire fixe se positionne par rapport à ce conteneur */
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        /* Ajout d'un padding pour que le dernier message ne soit pas caché par le formulaire */
        padding-bottom: 70px; /* Ajustez cette valeur si la hauteur du formulaire change */
    }

    .fixed-bottom-input {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: white;
        padding: 10px;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        z-index: 999;
    }
}
    </style>
</head>

<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="p-4">
            <h4 class="text-center mb-4 logo">
                <i class="fas fa-home me-2 text-primary"></i> IMMO ABIDJAN
            </h4>
            <div class="d-flex align-items-center mb-4 p-3 bg-light rounded ma_section_identity">
                <img src="https://ui-avatars.com/api/?name={{ utilisateur.first_name }}+{{ utilisateur.last_name }}&background=1e4a8d&color=fff"
                    class="rounded-circle me-3" width="40" height="40">
                <div class="identity">
                    <h6 class="mb-0">{{ utilisateur.get_full_name }}</h6>
                    <small class="text-muted">{{ utilisateur.role }}</small>
                </div>
            </div>

            <ul class="nav flex-column">
                <li class="nav-item"><a class="nav-link" href="{% url 'proprietaire' %}"><i
                            class="fas fa-tachometer-alt me-2"></i> Tableau de bord</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'mes_proprietes' %}"><i
                            class="fas fa-home me-2"></i> Mes propriétés</a></li>
                <li class="nav-item"><a class="nav-link active" href="{% url 'mes_messages'%}"><i
                            class="fas fa-envelope me-2"></i> Messages</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'statistiques' %}"><i
                            class="fas fa-chart-line me-2"></i> Statistiques</a></li>
                <li class="nav-item mt-3"><a class="nav-link" href="{% url 'proprietaire_parametres' %}"><i
                            class="fas fa-cog me-2"></i> Paramètres</a></li>
                <li class="nav-item"><a class="nav-link" href="#"><i class="fas fa-sign-out-alt me-2"></i>
                        Déconnexion</a></li>
            </ul>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <nav class="navbar navbar-expand-lg nav">
            <div class="container-fluid justify-content-end">
                <div class="d-none d-md-block me-auto">
                    <h5 class="mb-0 margin">Messages</h5>
                </div>

                <div>
                    <!-- Bouton pour afficher les conversations (mobile uniquement) -->
                    <button id="toggleConversations" class="btn btn-primary d-md-none mb-2">
                        <i class="fas fa-comments"></i> Discussions
                    </button>
                    <a class="nav-link" href="{% url 'index'%}">
                        <i class="fas fa-home me-2"></i>
                    </a>
                </div>
                <button class="btn btn-accent">
                    <i class="fas fa-plus-circle me-1"></i> Ajouter une propriété
                </button>
            </div>
        </nav>

        <div class="container-fluid px-3 toutechange">
            <div class="dashboard-card messaging-layout">


                <div class="conversations-list list-group">
    {% for conversation in conversations %}
    <div class="list-group-item d-flex align-items-center {% if conversation.pk == contact_actuel.pk %}active{% endif %}">
        
        <!-- Lien vers la conversation -->
        <a href="{% url 'mes_messages_detail' contact_pk=conversation.pk %}"
           class="d-flex align-items-center flex-grow-1 text-decoration-none text-dark">
            <div class="icon-badge bg-primary d-flex align-items-center justify-content-center"
                 style="width:40px; height:40px; overflow:hidden; border-radius:50%;">
                {% if conversation.utilisateur == utilisateur %}
                    {% if conversation.proprietaire.photo %}
                        <img src="{{ conversation.proprietaire.photo.url }}" alt="Photo"
                             style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                        <i class="fas fa-user" style="font-size:18px; color:white;"></i>
                    {% endif %}
                {% else %}
                    {% if conversation.utilisateur.photo %}
                        <img src="{{ conversation.utilisateur.photo.url }}" alt="Photo"
                             style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                        <i class="fas fa-user" style="font-size:18px; color:white;"></i>
                    {% endif %}
                {% endif %}
            </div>
            <div class="ms-2">
                <strong>
                    {% if conversation.utilisateur == utilisateur %}
                        {{ conversation.proprietaire.get_full_name }}
                    {% else %}
                        {{ conversation.utilisateur.get_full_name|default:"Visiteur" }}
                    {% endif %}
                </strong><br>
                <small>{{ conversation.propriete.titre }}</small>
            </div>
        </a>

        <!-- Bouton supprimer -->
        <form method="post" action="{% url 'supprimer_conversation' contact_pk=conversation.pk %}" 
              onsubmit="return confirm('Supprimer cette conversation ?');" class="ms-auto">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger">
                <i class="fas fa-trash"></i>
            </button>
        </form>
    </div>
    {% empty %}
    <p class="text-center p-3">Aucune conversation pour le moment.</p>
    {% endfor %}
</div>



<div class="chat-window">
    {% if contact_actuel %}
    <div class="chat-container">
        <div class="chat-messages">
            {% for message in messages %}
            <div class="chat-message {% if message.expediteur == utilisateur %}from-user{% endif %}">
                <p>{{ message.contenu }}</p>
                <small class="text-muted d-block">{{ message.date_envoi|date:"H:i" }}</small>
            </div>
            {% endfor %}
        </div>
        <div class="chat-input fixed-bottom-input">
            <form method="post" action="{% url 'send_message' contact_pk=contact_actuel.pk %}">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" name="contenu" class="form-control"
                        placeholder="Écrire un message..." required />
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% else %}
    <p class="text-center p-5">Sélectionnez une conversation pour commencer à discuter.</p>
    {% endif %}
</div>


            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const mobileMenuBtn = document.getElementById("mobileMenuBtn");
            const sidebar = document.getElementById("sidebar");

            mobileMenuBtn.addEventListener("click", function () {
                sidebar.classList.toggle("active");
            });

            // Nouveau : bouton pour afficher les conversations
            const toggleConversations = document.getElementById("toggleConversations");
            const conversationsList = document.querySelector(".conversations-list");

            if (toggleConversations) {
                toggleConversations.addEventListener("click", function () {
                    conversationsList.classList.toggle("active");
                });
            }
        });

    </script>
</body>

</html>